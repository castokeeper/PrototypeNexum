// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum TipoSolicitud {
  nuevo_ingreso
  reinscripcion
}

enum EstatusSolicitud {
  pendiente
  aprobada
  rechazada
}

enum RolUsuario {
  admin
  director
  control_escolar
  aspirante
}

enum TurnoEnum {
  matutino
  vespertino
  nocturno
}

enum TipoDocumento {
  comprobante_pago
  identificacion
  certificado
}

enum AccionAuditoria {
  INSERT
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

enum EstatusFicha {
  pendiente
  programado
  presentado
  aprobado
  rechazado
  cancelado
}

enum EstadoEspera {
  en_espera
  aceptado
  rechazado
  cancelado
  expirado
}

enum EstatusAlumno {
  aspirante
  activo
  baja_temporal
  egresado
  baja_definitiva
}

enum EstatusUsuario {
  en_revision
  pendiente_formulario
  pendiente_pago
  activo
  rechazado
  suspendido
  egresado
}

enum EstatusPago {
  pendiente
  procesando
  pagado
  fallido
  reembolsado
}

// ============================================
// MODELOS
// ============================================

model Usuario {
  id           Int             @id @default(autoincrement())
  username     String          @unique @db.VarChar(50)
  passwordHash String          @map("password_hash") @db.VarChar(255)
  nombre       String          @db.VarChar(100)
  email        String?         @unique @db.VarChar(100)
  rol          RolUsuario      @default(aspirante)
  activo       Boolean         @default(true)
  temporal     Boolean         @default(true)
  estatus      EstatusUsuario  @default(en_revision)
  ultimoAcceso DateTime?       @map("ultimo_acceso") @db.Timestamp()
  fechaRechazo DateTime?       @map("fecha_rechazo") @db.Timestamp()
  createdAt    DateTime        @default(now()) @map("created_at") @db.Timestamp()
  updatedAt    DateTime        @updatedAt @map("updated_at") @db.Timestamp()

  // Relaciones
  solicitudesAprobadas  Solicitud[]   @relation("AprobadoPor")
  solicitudesRechazadas Solicitud[]   @relation("RechazadoPor")
  auditorias            Auditoria[]
  fichaExamen           FichaExamen?  @relation("UsuarioFicha")
  solicitudes           Solicitud[]   @relation("UsuarioSolicitudes")
  pagos                 Pago[]

  @@index([username])
  @@index([email])
  @@index([estatus])
  @@index([temporal])
  @@map("usuarios")
}

model Carrera {
  id        Int      @id @default(autoincrement())
  nombre    String   @unique @db.VarChar(100)
  codigo    String?  @unique @db.VarChar(20)
  activa    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relaciones
  solicitudes  Solicitud[]
  fichasExamen FichaExamen[]

  @@index([activa])
  @@index([codigo])
  @@map("carreras")
}

model Alumno {
  id              Int      @id @default(autoincrement())
  nombre          String   @db.VarChar(100)
  apellidoPaterno String   @map("apellido_paterno") @db.VarChar(100)
  apellidoMaterno String   @map("apellido_materno") @db.VarChar(100)
  curp            String   @unique @db.VarChar(18)
  fechaNacimiento DateTime @map("fecha_nacimiento") @db.Date
  telefono        String   @db.VarChar(15)
  email           String   @unique @db.VarChar(100)
  direccion       String?  @db.Text

  // Control de semestre y estado
  fichaExamenId  Int?          @unique @map("ficha_examen_id")
  semestreActual Int?          @default(1) @map("semestre_actual") @db.SmallInt
  estatusAlumno  EstatusAlumno @default(activo) @map("estatus_alumno")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp()

  // Relaciones
  fichaExamen FichaExamen? @relation(fields: [fichaExamenId], references: [id])
  solicitudes Solicitud[]

  @@index([curp])
  @@index([email])
  @@index([apellidoPaterno, apellidoMaterno, nombre])
  @@index([createdAt(sort: Desc)])
  @@map("alumnos")
}

model Solicitud {
  id        Int              @id @default(autoincrement())
  usuarioId Int?             @map("usuario_id")
  alumnoId  Int?             @map("alumno_id")
  carreraId Int              @map("carrera_id")
  tipo      TipoSolicitud
  estatus   EstatusSolicitud @default(pendiente)

  // Datos del formulario de inscripción (JSON)
  datosPersonales Json? @map("datos_personales") @db.JsonB
  datosAcademicos Json? @map("datos_academicos") @db.JsonB
  datosTutor      Json? @map("datos_tutor") @db.JsonB

  // Datos específicos de reinscripción
  matricula String? @db.VarChar(20)
  semestre  Int?    @db.SmallInt
  grupo     String? @db.Char(1)

  // Datos comunes
  turno TurnoEnum

  // Pago
  estatusPago     EstatusPago @default(pendiente) @map("estatus_pago")
  montoPagar      Decimal?    @map("monto_pagar") @db.Decimal(10, 2)
  stripeSessionId String?     @unique @map("stripe_session_id") @db.VarChar(255)
  fechaPago       DateTime?   @map("fecha_pago") @db.Timestamp()

  // Fechas y seguimiento
  fechaSolicitud     DateTime  @default(now()) @map("fecha_solicitud") @db.Timestamp()
  fechaActualizacion DateTime  @updatedAt @map("fecha_actualizacion") @db.Timestamp()
  aprobadoPor        Int?      @map("aprobado_por")
  fechaAprobacion    DateTime? @map("fecha_aprobacion") @db.Timestamp()
  rechazadoPor       Int?      @map("rechazado_por")
  fechaRechazo       DateTime? @map("fecha_rechazo") @db.Timestamp()

  // Comentarios
  comentarios String? @db.Text

  // Relaciones
  usuario    Usuario?    @relation("UsuarioSolicitudes", fields: [usuarioId], references: [id], onDelete: Cascade)
  alumno     Alumno?     @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  carrera    Carrera     @relation(fields: [carreraId], references: [id])
  aprobador  Usuario?    @relation("AprobadoPor", fields: [aprobadoPor], references: [id])
  rechazador Usuario?    @relation("RechazadoPor", fields: [rechazadoPor], references: [id])
  documentos Documento[]
  pagos      Pago[]

  @@index([usuarioId])
  @@index([alumnoId])
  @@index([carreraId])
  @@index([tipo])
  @@index([estatus])
  @@index([estatusPago])
  @@index([fechaSolicitud(sort: Desc)])
  @@index([matricula])
  @@index([aprobadoPor])
  @@map("solicitudes")
}

model Documento {
  id            Int           @id @default(autoincrement())
  solicitudId   Int           @map("solicitud_id")
  tipoDocumento TipoDocumento @default(comprobante_pago) @map("tipo_documento")
  nombreArchivo String        @map("nombre_archivo") @db.VarChar(255)
  rutaArchivo   String        @map("ruta_archivo") @db.Text
  mimeType      String        @map("mime_type") @db.VarChar(100)
  tamanioBytes  Int           @map("tamaño_bytes")
  hashSha256    String?       @map("hash_sha256") @db.VarChar(64)
  uploadedAt    DateTime      @default(now()) @map("uploaded_at") @db.Timestamp()

  // Relaciones
  solicitud Solicitud @relation(fields: [solicitudId], references: [id], onDelete: Cascade)

  @@index([solicitudId])
  @@index([tipoDocumento])
  @@index([uploadedAt(sort: Desc)])
  @@map("documentos")
}

model Auditoria {
  id              Int             @id @default(autoincrement())
  tablaAfectada   String          @map("tabla_afectada") @db.VarChar(50)
  registroId      Int             @map("registro_id")
  accion          AccionAuditoria
  usuarioId       Int?            @map("usuario_id")
  datosAnteriores Json?           @map("datos_anteriores") @db.JsonB
  datosNuevos     Json?           @map("datos_nuevos") @db.JsonB
  ipAddress       String?         @map("ip_address") @db.Inet
  userAgent       String?         @map("user_agent") @db.Text
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamp()

  // Relaciones
  usuario Usuario? @relation(fields: [usuarioId], references: [id])

  @@index([tablaAfectada])
  @@index([registroId])
  @@index([usuarioId])
  @@index([createdAt(sort: Desc)])
  @@index([accion])
  @@map("auditoria")
}

// ============================================
// SISTEMA DE FICHAS Y LISTA DE ESPERA
// ============================================

model FichaExamen {
  id    Int    @id @default(autoincrement())
  folio String @unique @db.VarChar(20)

  // Datos del aspirante
  nombre          String   @db.VarChar(100)
  apellidoPaterno String   @map("apellido_paterno") @db.VarChar(100)
  apellidoMaterno String   @map("apellido_materno") @db.VarChar(100)
  curp            String   @unique @db.VarChar(18)
  fechaNacimiento DateTime @map("fecha_nacimiento") @db.Date
  telefono        String   @db.VarChar(15)
  email           String   @unique @db.VarChar(100)
  direccion       String?  @db.Text

  // Datos del examen
  carreraId      Int       @map("carrera_id")
  turnoPreferido TurnoEnum @map("turno_preferido")
  fechaExamen    DateTime? @map("fecha_examen") @db.Timestamp()
  lugarExamen    String?   @map("lugar_examen") @db.VarChar(255)

  // Estado y resultados
  estatus      EstatusFicha @default(pendiente)
  calificacion Float?       @db.Real
  aprobado     Boolean?

  // Usuario asociado (creado al registrarse)
  usuarioId Int? @unique @map("usuario_id")

  // Fechas
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp()

  // Relaciones
  carrera     Carrera      @relation(fields: [carreraId], references: [id])
  usuario     Usuario?     @relation("UsuarioFicha", fields: [usuarioId], references: [id], onDelete: Cascade)
  listaEspera ListaEspera?
  alumno      Alumno? // Si fue aceptado

  @@index([folio])
  @@index([curp])
  @@index([email])
  @@index([estatus])
  @@index([carreraId])
  @@index([createdAt(sort: Desc)])
  @@map("fichas_examen")
}

model ListaEspera {
  id           Int          @id @default(autoincrement())
  fichaId      Int          @unique @map("ficha_id")
  posicion     Int // Posición en la lista
  estadoActual EstadoEspera @default(en_espera) @map("estado_actual")

  // Fechas importantes
  fechaIngreso    DateTime  @default(now()) @map("fecha_ingreso") @db.Timestamp()
  fechaAceptacion DateTime? @map("fecha_aceptacion") @db.Timestamp()
  fechaRechazo    DateTime? @map("fecha_rechazo") @db.Timestamp()

  // Notas
  observaciones String? @db.Text

  // Relaciones
  ficha FichaExamen @relation(fields: [fichaId], references: [id], onDelete: Cascade)

  @@index([posicion])
  @@index([estadoActual])
  @@index([fechaIngreso(sort: Desc)])
  @@map("lista_espera")
}
