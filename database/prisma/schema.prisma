// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum TipoSolicitud {
  nuevo_ingreso
  reinscripcion
}

enum EstatusSolicitud {
  pendiente
  aprobada
  rechazada
}

enum RolUsuario {
  admin
  director
  control_escolar
}

enum TurnoEnum {
  matutino
  vespertino
  nocturno
}

enum TipoDocumento {
  comprobante_pago
  identificacion
  certificado
}

enum AccionAuditoria {
  INSERT
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

// ============================================
// MODELOS
// ============================================

model Usuario {
  id                  Int                @id @default(autoincrement())
  username            String             @unique @db.VarChar(50)
  passwordHash        String             @map("password_hash") @db.VarChar(255)
  nombre              String             @db.VarChar(100)
  email               String?            @unique @db.VarChar(100)
  rol                 RolUsuario         @default(control_escolar)
  activo              Boolean            @default(true)
  ultimoAcceso        DateTime?          @map("ultimo_acceso") @db.Timestamp()
  createdAt           DateTime           @default(now()) @map("created_at") @db.Timestamp()
  updatedAt           DateTime           @updatedAt @map("updated_at") @db.Timestamp()

  // Relaciones
  solicitudesAprobadas Solicitud[]       @relation("AprobadoPor")
  solicitudesRechazadas Solicitud[]      @relation("RechazadoPor")
  auditorias          Auditoria[]

  @@index([username])
  @@index([rol])
  @@index([activo])
  @@map("usuarios")
}

model Carrera {
  id         Int         @id @default(autoincrement())
  nombre     String      @unique @db.VarChar(100)
  codigo     String?     @unique @db.VarChar(20)
  activa     Boolean     @default(true)
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamp()

  // Relaciones
  solicitudes Solicitud[]

  @@index([activa])
  @@index([codigo])
  @@map("carreras")
}

model Alumno {
  id               Int         @id @default(autoincrement())
  nombre           String      @db.VarChar(100)
  apellidoPaterno  String      @map("apellido_paterno") @db.VarChar(100)
  apellidoMaterno  String      @map("apellido_materno") @db.VarChar(100)
  curp             String      @unique @db.VarChar(18)
  fechaNacimiento  DateTime    @map("fecha_nacimiento") @db.Date
  telefono         String      @db.VarChar(15)
  email            String      @unique @db.VarChar(100)
  direccion        String?     @db.Text
  createdAt        DateTime    @default(now()) @map("created_at") @db.Timestamp()
  updatedAt        DateTime    @updatedAt @map("updated_at") @db.Timestamp()

  // Relaciones
  solicitudes      Solicitud[]

  @@index([curp])
  @@index([email])
  @@index([apellidoPaterno, apellidoMaterno, nombre])
  @@index([createdAt(sort: Desc)])
  @@map("alumnos")
}

model Solicitud {
  id                  Int               @id @default(autoincrement())
  alumnoId            Int               @map("alumno_id")
  carreraId           Int               @map("carrera_id")
  tipo                TipoSolicitud
  estatus             EstatusSolicitud  @default(pendiente)

  // Datos específicos de reinscripción
  matricula           String?           @db.VarChar(20)
  semestre            Int?              @db.SmallInt
  grupo               String?           @db.Char(1)

  // Datos comunes
  turno               TurnoEnum

  // Fechas y seguimiento
  fechaSolicitud      DateTime          @default(now()) @map("fecha_solicitud") @db.Timestamp()
  fechaActualizacion  DateTime          @updatedAt @map("fecha_actualizacion") @db.Timestamp()
  aprobadoPor         Int?              @map("aprobado_por")
  fechaAprobacion     DateTime?         @map("fecha_aprobacion") @db.Timestamp()
  rechazadoPor        Int?              @map("rechazado_por")
  fechaRechazo        DateTime?         @map("fecha_rechazo") @db.Timestamp()

  // Comentarios
  comentarios         String?           @db.Text

  // Relaciones
  alumno              Alumno            @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  carrera             Carrera           @relation(fields: [carreraId], references: [id])
  aprobador           Usuario?          @relation("AprobadoPor", fields: [aprobadoPor], references: [id])
  rechazador          Usuario?          @relation("RechazadoPor", fields: [rechazadoPor], references: [id])
  documentos          Documento[]

  @@index([alumnoId])
  @@index([carreraId])
  @@index([tipo])
  @@index([estatus])
  @@index([fechaSolicitud(sort: Desc)])
  @@index([matricula])
  @@index([aprobadoPor])
  @@map("solicitudes")
}

model Documento {
  id              Int            @id @default(autoincrement())
  solicitudId     Int            @map("solicitud_id")
  tipoDocumento   TipoDocumento  @default(comprobante_pago) @map("tipo_documento")
  nombreArchivo   String         @map("nombre_archivo") @db.VarChar(255)
  rutaArchivo     String         @map("ruta_archivo") @db.Text
  mimeType        String         @map("mime_type") @db.VarChar(100)
  tamañoBytes     Int            @map("tamaño_bytes")
  hashSha256      String?        @map("hash_sha256") @db.VarChar(64)
  uploadedAt      DateTime       @default(now()) @map("uploaded_at") @db.Timestamp()

  // Relaciones
  solicitud       Solicitud      @relation(fields: [solicitudId], references: [id], onDelete: Cascade)

  @@index([solicitudId])
  @@index([tipoDocumento])
  @@index([uploadedAt(sort: Desc)])
  @@map("documentos")
}

model Auditoria {
  id                Int              @id @default(autoincrement())
  tablaAfectada     String           @map("tabla_afectada") @db.VarChar(50)
  registroId        Int              @map("registro_id")
  accion            AccionAuditoria
  usuarioId         Int?             @map("usuario_id")
  datosAnteriores   Json?            @map("datos_anteriores") @db.JsonB
  datosNuevos       Json?            @map("datos_nuevos") @db.JsonB
  ipAddress         String?          @map("ip_address") @db.Inet
  userAgent         String?          @map("user_agent") @db.Text
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamp()

  // Relaciones
  usuario           Usuario?         @relation(fields: [usuarioId], references: [id])

  @@index([tablaAfectada])
  @@index([registroId])
  @@index([usuarioId])
  @@index([createdAt(sort: Desc)])
  @@index([accion])
  @@map("auditoria")
}

